# Benchmark

This directory stores atlasmtl benchmark assets, comparator wrappers, and the
benchmark runner.

## Current scope

The benchmark layer is intentionally conservative but no longer atlasmtl-only.

- implemented methods: `atlasmtl`, `reference_knn`, `celltypist`, `scanvi`,
  `singler`, `symphony`, `azimuth`
- the runner focuses on reproducible reporting and stable method wrappers
- the runner supports a single config block per method per run
- multi-run comparator matrices across many datasets and variants are not fully
  wired in yet

## Layout

- `datasets/`
  - dataset descriptors and mapping tables
- `methods/`
  - wrappers for atlasmtl and current comparator methods
- `pipelines/`
  - end-to-end benchmark runners
- `metrics/`
  - metric implementations and metric helpers
- `reports/`
  - generated benchmark outputs and downstream summaries

## Current runner outputs

`benchmark/pipelines/run_benchmark.py` writes:

- `metrics.json`
  - machine-readable benchmark payload
- `summary.csv`
  - flat per-level summary table
- `summary_by_domain.csv`
  - optional domain-grouped report when `domain_key` is present
- `run_manifest.json`
  - run-level traceability payload with best-effort artifact checksums
- `benchmark_report.md`
  - optional markdown summary generated by
    `benchmark/reports/generate_markdown_report.py`
- `paper_tables/`
  - optional CSV + Markdown table exports generated by
    `benchmark/reports/export_paper_tables.py`

## Metric focus today

- multi-level classification quality
- abstention and coverage quality
- prediction behavior metrics such as Unknown rate and KNN rescue rate
- calibration quality
- hierarchy path consistency metrics when hierarchy rules are supplied
- runtime and artifact accounting
- coordinate RMSE, trustworthiness, continuity, and neighbor overlap

## Runtime environments

- Python env:
  `/home/data/fhz/.local/share/mamba/envs/atlasmtl-env`
- `NUMBA_CACHE_DIR` recommendation:
  `/tmp/numba_cache`
- native `Azimuth` / `Seurat v5` R library:
  `/home/data/fhz/seurat_v5`
- repo-local comparator R library:
  `/home/data/fhz/project/phmap_package/atlasmtl/.r_libs`

## Comparator notes

- `celltypist` and `scanvi` use the Python env directly
- `singler` and `symphony` use R bridge scripts
- `azimuth` prefers a native `Azimuth` backend and records the actual backend
  in result metadata
- tiny synthetic smoke tests may use `seurat_anchor_transfer_fallback` for
  `azimuth`; formal result tables should prefer `azimuth_native`

## Known limitations

- dataset manifest schema is documented in
  `documents/protocols/experiment_protocol.md`
- domain-shift split definitions are not yet standardized
- comparator-aligned hierarchy and topology reporting is not yet standardized
- most external comparators are evaluated as single-level label-transfer
  methods, so comparator fairness currently depends on fixing one shared target
  label column
