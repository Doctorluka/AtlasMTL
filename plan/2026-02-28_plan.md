# atlasmtl Project Plan

Date: 2026-02-28
Project root: `/home/data/fhz/project/phmap_package/atlasmtl`
Package root: `/home/data/fhz/project/phmap_package/atlasmtl/atlasmtl`

## Summary
`atlasmtl` is a new Python package developed alongside, but independently from, `phmap`. It keeps the `AnnData in -> AnnData out` design while extending the current multi-task learning (MTL) framework with reference-coordinate prediction, low-confidence-gated KNN correction, and `Unknown` abstention.

The project should support multi-level annotation, coordinate prediction (`latent` and `UMAP`), benchmark pipelines, and paper-oriented documentation in one repository.

## Confirmed Design Decisions
- The new project name is `atlasmtl`.
- The repository root is `/home/data/fhz/project/phmap_package/atlasmtl`.
- Package code lives in `/home/data/fhz/project/phmap_package/atlasmtl/atlasmtl`.
- A read-only reference snapshot of the original `phmap` code is stored separately and is not the main development target.
- The package must preserve the `AnnData in, AnnData out` workflow.
- Default latent strategy is `internal_preferred`: internal latent prediction is preferred, with fallback to external latent if needed.
- KNN correction is applied only to low-confidence cells by default.
- Confidence gating is performed independently for each label level, not only the finest level.
- If both MTL and KNN remain low-confidence, the model should assign `Unknown` instead of forcing a label.

## Project Layout
The repository should contain the following top-level structure:

- `atlasmtl/`: Python package source code
- `benchmark/`: benchmark pipelines, baseline wrappers, metrics, and reports
- `notebooks/`: example workflows and reproducible demonstrations
- `documents/`: architecture, experimental protocols, and paper assets
- `tests/`: unit, integration, and regression tests
- `scripts/`: CLI utilities for training, inference, and benchmark execution
- `configs/`: model defaults, benchmark settings, and threshold presets
- `data_registry/`: dataset manifests, split definitions, and label mapping notes
- `vendor/phmap_snapshot/`: read-only source snapshot from the original `phmap`
- `plan/`: dated planning documents and decision records

## Package Architecture
Within `atlasmtl/`, the codebase should be organized into:

- `core/`: model definition, training loop, and high-level API
- `mapping/`: KNN correction, label fusion, and unknown-cell logic
- `io/`: AnnData field writing and IO helpers
- `models/`: model registry and packaged model utilities
- `pl/`: plotting helpers
- `utils/`: shared utility functions
- `version.py`: package version management

## Core Modeling Strategy
The default model is a shared-encoder neural network with:

- multiple classification heads for hierarchical labels
- one latent coordinate head
- one UMAP coordinate head

The design should preserve MTL shared representation learning while enabling reference-aware coordinate supervision.

## AnnData Output Contract
Inference should automatically write outputs back into `AnnData` with consistent field names.

Required outputs include:

- `obsm["X_pred_latent"]`
- `obsm["X_pred_umap"]`
- `obs["pred_<level>_raw"]`
- `obs["pred_<level>"]`
- `obs["conf_<level>"]`
- `obs["margin_<level>"]`
- `obs["is_low_conf_<level>"]`
- `obs["is_unknown_<level>"]`
- `uns["atlasmtl"]` for thresholds, KNN settings, latent source, and model metadata

## Confidence and Unknown Policy
Confidence handling is level-specific.

Recommended default thresholds:

- high confidence: `max_prob >= 0.7` and `margin >= 0.2`
- low confidence / Unknown boundary: `max_prob < 0.4`
- intermediate confidence: trigger optional KNN correction

The purpose is to avoid overconfident mislabeling while preserving usable coarse-level predictions when fine-level labels are uncertain.

## KNN Correction Strategy
KNN correction should not be run for every cell by default.

Default behavior:

- run MTL prediction first
- identify low-confidence cells independently for each level
- apply KNN correction only to those low-confidence cells
- if corrected confidence remains too low, mark the cell as `Unknown`

This keeps compute cost lower than a full-cell correction pass while preserving the main benefit of coordinate-guided rescue.

## Benchmark Plan
Benchmarking should evaluate more than final label accuracy.

### Primary benchmark axis
- multi-level classification performance
- calibration quality
- abstention / Unknown behavior

Suggested metrics:
- Macro-F1
- Balanced Accuracy
- ECE
- Brier score
- coverage-risk curves
- AURC

### Secondary benchmark axis
- training and inference runtime
- memory usage
- coordinate prediction quality
- neighborhood preservation quality

Suggested metrics:
- wall-clock training time
- wall-clock inference time
- peak memory
- RMSE for latent / UMAP coordinates
- kNN overlap
- trustworthiness / continuity

### Comparator methods
Planned method comparisons include:
- `scANVI`
- `CellTypist`
- `SingleR`
- `ProjectSVR`
- `Seurat/Azimuth`-style transfer where appropriate

### Planned ablations
- `MTL only`
- `MTL + coordinate heads`
- `MTL + coordinate heads + gated KNN`
- `MTL + coordinate heads + gated KNN + Unknown`

## Dataset Planning
The benchmark focus should emphasize datasets with multi-level annotation, consistent with the original motivation behind `phmap`.

Planned core direction:
- use multi-level annotated datasets such as HLCA and similar resources

TODO for later completion:
- final dataset list
- dataset versions and paths
- label harmonization rules
- train / validation / test split definitions
- OOD evaluation scenarios

## Paper-Oriented Assets
The repository should be structured so that later manuscript writing can directly reuse project outputs.

Planned paper support includes:
- `documents/design/`: method architecture and implementation rationale
- `documents/protocols/`: experiment protocols, seeds, and hardware notes
- `documents/paper/figures/`: draft figures
- `documents/paper/tables/`: result tables
- `documents/paper/claims.md`: major claims mapped to evidence

## Implementation Phases
### Phase 0: Scaffold
- create the repository structure
- initialize the Python package
- add the read-only `phmap` snapshot

### Phase 1: Baseline package migration
- port the current `phmap` MTL logic into `atlasmtl/core`
- keep a minimal working `build_model()` and `predict()` API
- preserve the AnnData IO pattern

### Phase 2: Reference-aware extension
- add latent and UMAP coordinate heads
- add confidence estimation and per-level gating
- implement low-confidence-only KNN correction
- implement `Unknown` abstention

### Phase 3: Benchmark pipeline
- create consistent evaluation scripts and configs
- add baseline wrappers
- generate reproducible report tables and figures

### Phase 4: Paper-ready packaging
- organize reproducibility records
- finalize benchmark outputs
- prepare paper figures, tables, and claims mappings

## Acceptance Criteria
The project should be considered on track when:

- `atlasmtl` can train and predict through an `AnnData -> AnnData` workflow
- the expected `obs`, `obsm`, and `uns` outputs are written automatically
- KNN correction supports `off`, `low_conf_only`, and `all` modes
- `Unknown` labels are produced for sufficiently low-confidence predictions
- the benchmark pipeline can compare `atlasmtl` against baseline methods
- the repository structure supports future manuscript writing without major reorganization
