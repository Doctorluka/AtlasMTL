# 2026-02-28 Exec Plan: Core Self-Consistency + Fair Benchmark Protocol

## Goal
Make `atlasmtl` methodologically self-consistent and benchmark-ready for fair comparison against published tools (not `phmap`).

## Locked Decisions
- Benchmark goal: fair comparison.
- Default input: `binary`.
- Unknown policy: MTL + KNN closed-loop.
- Keep `float` as optional mode (not default).

## Scope
- P0: input transform + KNN off + KNN confidence + closed-loop Unknown + richer `uns["atlasmtl"]`.
- P1: optional val split + early stopping; batching to reduce inference peak memory.
- P2: refactor mapping/io; add minimal evaluate; add benchmark protocol + runner skeleton.

## P0 Changes (Must)
### 1) Input transform explicit
- File: `atlasmtl/core/api.py`
- Change: `_extract_matrix(..., input_transform)` supports `binary|float`.
- Change: `build_model(..., input_transform="binary")`; `predict(..., input_transform=None -> model default)`.
- Record: `uns["atlasmtl"]["input_transform"]`.

### 2) KNN modes include off
- File: `atlasmtl/core/api.py`
- Change: `predict(knn_correction)` supports `off|low_conf_only|all`.

### 3) KNN confidence output
- New file: `atlasmtl/mapping/knn.py`
- API: `knn_majority_vote(...) -> (label, vote_frac, vote_margin)`.
- File: `atlasmtl/core/api.py`
- Add columns per level: `pred_<lvl>`, `pred_<lvl>_knn`, `knn_vote_frac_<lvl>`, `is_low_knn_conf_<lvl>`, `used_knn_<lvl>`.

### 4) Closed-loop Unknown
- New file: `atlasmtl/mapping/confidence.py`
- Rule:
  - `mtl_unknown = max_prob < confidence_low`
  - If KNN applied: Unknown if `mtl_low_conf AND knn_vote_frac < knn_conf_low`
  - Final: Unknown if `mtl_unknown OR (used_knn AND mtl_low_conf AND knn_low_conf)`
- File: `configs/thresholds/default.yaml`
- Add: `knn_conf_low` (default `0.6`).

### 5) Metadata enrichment
- File: `atlasmtl/core/api.py`
- Add to `uns["atlasmtl"]`:
  - `knn_space_used` (latent/umap)
  - per-level `knn_coverage_<lvl>`
  - `knn_conf_low`
  - training config snapshot (see P1/TrainedModel).

## P1 Changes (Should)
### 6) Optional validation + early stopping
- File: `atlasmtl/core/api.py`
- Add params: `val_fraction`, `early_stopping_patience`, `early_stopping_min_delta`, `random_state`.
- Default: disabled to preserve current behavior.

### 7) Reduce inference peak memory
- File: `atlasmtl/core/api.py`
- Change: infer with `DataLoader` batches (avoid one giant torch tensor if possible).

### 8) Training config stored
- File: `atlasmtl/core/api.py`
- Extend `TrainedModel` metadata with `input_transform` + `train_config` dict.
- Backward-compat load: tolerate missing keys.

## P2 Changes (Nice to Have / Next)
### 9) Refactor out of core
- Move KNN/Unknown helpers into `atlasmtl/mapping/`.
- Optionally add `atlasmtl/io/writeback.py` to centralize AnnData writes.

### 10) Minimal evaluate
- New file: `atlasmtl/core/evaluate.py`
- Metrics: accuracy/macro-F1/balanced-acc + coverage/risk helpers.

### 11) Benchmark protocol + runner skeleton
- New doc: `benchmark/protocol.md`
- New skeleton: `benchmark/pipelines/run_benchmark.py`
- Define abstention normalization and metric set for published-tool comparisons.

## Tests (Add)
- `tests/unit/`:
  - binary transform produces 0/1 only.
  - `knn_correction="off"` never sets `used_knn_*`.
  - KNN vote_frac columns exist when KNN applied.
  - closed-loop Unknown triggers on low MTL + low KNN conf.
  - `uns["atlasmtl"]` records `input_transform` + `knn_space_used`.
- `tests/integration/`:
  - tiny AnnData train+predict writes required `obs/obsm/uns`.

## Acceptance
- `predict()` supports `off|low_conf_only|all`.
- Per level outputs include KNN confidence and closed-loop Unknown behavior.
- `uns["atlasmtl"]` contains input transform, KNN space, coverage, thresholds.
- Unit + integration tests pass.

## Assumptions and Defaults
- Default `input_transform` is `"binary"`.
- Default `knn_conf_low = 0.6`.
- Unknown is assigned when MTL is clearly low-confidence, or when KNN is triggered and also low-confidence.
- `float` input mode remains supported for later sensitivity analysis.
- Sparse-native training/inference is out of scope for this iteration.
